#include <stdlib.h>
#include <sys/types.h>
#include <unistd.h>
#include <sys/wait.h>
#include <time.h>
#include <sys/resource.h>
#include <sys/time.h>

#include <string>
#include <string.h>
#include <iostream>
#include <stdio.h>
using namespace std;

string exec(char* cmd)
{
	//Opens a pipe which allows two processes to communicate

	FILE* pipe = popen(cmd, "r");

	if (!pipe) return "ERROR";

	//Buffer reads from file

	char buffer[128];
	string result = "";

	while(!feof(pipe))
	{
		//Result reads from buffer

		if(fgets(buffer, 128, pipe) != NULL)
			result += buffer;
	}

	//Pipe closed

	pclose(pipe);

	return result;
}

int main(int argc, char *argv[])
{
	int status;
	int who = RUSAGE_CHILDREN;

	struct rusage usage;
	struct rusage before_usage;
	struct timeval start, end;

	string output;
	char new_dir[200];
	int run_exec = 1;
	char input[200]="\0",token[50];
	
	for(int i=1;i<argc;i++)
	{
		strcat(input,argv[i]);
		strcat(input," ");
	}
	
	begin:
	strcpy(token,strtok(input," "));
	
	//cout<<token<< endl;
	
	if(strcmp(token,"cd")==0)
	{
		run_exec=0;
		strcpy(new_dir,get_current_dir_name());
		
		if(strcmp(argv[2],"..")==0)
		{
			int len=strlen(new_dir);
			while(new_dir[len-1]!='/')
			{
				len--;
			}
			new_dir[len-1]='\0';
			
			chdir(new_dir);
			cout<<get_current_dir_name()<<endl;
		}		
		else
		{	
			strcat(new_dir,"/");
			strcat(new_dir,argv[2]);
		
			chdir(new_dir);
			cout<<get_current_dir_name()<<endl;
		}
		
		cout<<"Directory changed\n\nEnter new command: ";
		cin.getline(input,200,'\n');
		run_exec=1;
		goto begin;
		
	}
			
	if(fork() != 0)
	{
		int start_time = gettimeofday(&start, NULL);
		
		if(run_exec == 1)
		{
			getrusage(who, &before_usage);
    			waitpid(-1, &status, 0);
    			int end_time = gettimeofday(&end, NULL);
    			double wall_time_passed = (end.tv_sec -start.tv_sec)*1000 + (end.tv_usec - start.tv_usec)/1000;
    			getrusage(who, &usage);
    			double user_time = (usage.ru_utime.tv_sec*1000 + usage.ru_utime.tv_usec/1000);
    			double system_time = (usage.ru_stime.tv_sec*1000 + usage.ru_stime.tv_usec/1000);

			
		        printf("Number of Page Faults: %ld \n", usage.ru_majflt -before_usage.ru_majflt);
			
			
			printf("Number of Page Reclaims: %ld \n", usage.ru_minflt - before_usage.ru_minflt);

			
			printf("Number of times preempted involuntarily: %ld \n", usage.ru_nivcsw - before_usage.ru_nivcsw);
			printf("Number of times preempted Voluntarily: %ld \n", usage.ru_nvcsw - before_usage.ru_nvcsw);
    			printf("User Time: %f \n", user_time);
    			printf("System Time: %f \n", system_time);
    			printf("Wall-Time: %f \n", (wall_time_passed));
		}
	}

	else
	{
		if(run_exec == 1)
		{
			output = exec(input);
			cout<<endl<<output<<endl;
		}
		/*else
		{
		
			cout<<getcwd();
			if(strcmp(argv[2],"..")==0)
			{
			
			}
		}*/
	}
	
	return 0;
}
