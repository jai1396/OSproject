#include <stdlib.h>
#include <sys/types.h>
#include <unistd.h>
#include <sys/wait.h>
#include <time.h>
#include <sys/resource.h>
#include <sys/time.h>
#include <string>
#include <string.h>
#include <iostream>
#include <stdio.h>

using namespace std;

enum PIPES {READ, WRITE};
int run_exec=1;



void displayStats(timeval start, timeval end, rusage usage, rusage before_usage)
{
	long softPF, hardPF;
	double wall_time_passed = (end.tv_sec -start.tv_sec)*1000 + (end.tv_usec - start.tv_usec)/1000;
	double user_time = (usage.ru_utime.tv_sec*1000 + usage.ru_utime.tv_usec/1000);
	double system_time = (usage.ru_stime.tv_sec*1000 + usage.ru_stime.tv_usec/1000);

	softPF = usage.ru_minflt-before_usage.ru_minflt;
	hardPF = usage.ru_majflt-before_usage.ru_majflt;
	
        cout<<"\nPROCESS STATISTICS\n\n";
        
        printf("User Time: %f \n", user_time);
 	printf("System Time: %f \n", system_time);       
 	printf("Wall-Time: %f \n", (wall_time_passed));       
 	printf("Number of times preempted involuntarily: %ld \n", usage.ru_nivcsw - before_usage.ru_nivcsw);       
	printf("Number of times preempted Voluntarily: %ld \n", usage.ru_nvcsw - before_usage.ru_nvcsw);      
        printf("Number of Page Faults: %ld \n", hardPF);
	printf("Number of Page Reclaims: %ld \n", softPF);
	
	cout<<endl;
}


string exec(char* cmd)
{
	//Opens a pipe which allows two processes to communicate

	FILE* pipe = popen(cmd, "r");

	if (!pipe) return "ERROR";

	//Buffer reads from file

	char buffer[128];
	string result = "";

	while(!feof(pipe))
	{
		//Result reads from buffer

		if(fgets(buffer, 128, pipe) != NULL)
			result += buffer;
	}

	//Pipe closed

	pclose(pipe);

	return result;
}

int main(int argc, char *argv[])
{
	int status;
	int who = RUSAGE_CHILDREN;
	int finalflag=0;

	struct rusage usage;
	struct rusage before_usage;
	struct timeval start, end;
	
	
	int hpipe[2], rpipe[2];
	pipe(hpipe);
	
	char ch;

	string output;
	
	char input[200]="\0",token[50], check[10],temp[200];
	char new_dir[200];
	char temp1_dir[200], temp2_dir[200];

	
	for(int i=1;i<argc;i++)
	{
		strcat(input,argv[i]);
		strcat(input," ");
	}
	
	
	
	begin:
	
	strcpy(temp,input);
	strcpy(token,strtok(temp," "));
	
	if(fork() != 0)
	{
		
		cout<<"Test14"<<endl;
		
		if(strcmp(token,"cd")==0)
		{
			cout<<"Test15"<<endl;
			
			run_exec=0;
			cout<<"Run exec = "<<run_exec<<endl;
			
			cout<<"Run exec = "<<run_exec<<endl;

			
			int start_time = gettimeofday(&start, NULL);
			if(run_exec == 0)
			{
				cout<<"Test16"<<endl;
				cout<<"Run exec = "<<run_exec<<endl;
				
				cout<<"Test16a"<<endl;
				strcpy(temp1_dir, get_current_dir_name());
				cout<<"Test16b"<<endl;
				
				
				
				getrusage(who, &before_usage);
				cout<<"Test17"<<endl;

	    			waitpid(-1, &status, 0);
	    			
	    			int x=0;
	    			
	    			//pipe for new_dir
	    			close(hpipe[WRITE]);
	    			while(true)
	    			{
	    				read(hpipe[READ], (char*)&new_dir[x], sizeof(char));
	    				if(new_dir[x]=='\0')
	    					break;
	    				else
	    					x++;
	    			}
	    			
	    			close (hpipe[READ]);
	    			
	    			cout<<"New dir = "<<new_dir<<endl;
	    			
	    			chdir(new_dir);
				

				cout<<"Temp1 = "<<temp1_dir<<endl;
	    			cout<<"Test18"<<endl;
	    			int end_time = gettimeofday(&end, NULL);
	    			getrusage(who, &usage);
	    			
	    			cout<<"Test19"<<endl;
	    			cout<<get_current_dir_name()<<endl;
	    			
	    			displayStats(start, end, usage, before_usage);
				cout<<"Test20"<<endl;
				
				strcpy(temp2_dir,get_current_dir_name());
				
				cout<<"Temp1 = "<<temp1_dir<<endl;
				cout<<"Temp2 = "<<temp2_dir<<endl;
		
						
				if(strcmp(temp1_dir, temp2_dir)==0)
					cout<<"Directory not changed\n";
				else
					cout<<"Directory changed\n";
				cout<<"Test21"<<endl;
			}	
		}
		else if(strcmp(token,"exit")==0)
		{
			finalflag=1;
			goto last;
		}
		else
		{
			int start_time = gettimeofday(&start, NULL);
					
			cout<<"Test22"<<endl;
			if(run_exec == 1)
			{
				getrusage(who, &before_usage);
				cout<<"Test23"<<endl;
	    			waitpid(-1, &status, 0);
	    			cout<<"Test24"<<endl;
	    			int end_time = gettimeofday(&end, NULL);
	    			getrusage(who, &usage);
	    			displayStats(start, end, usage, before_usage);
	    			cout<<"Test25"<<endl;
			}
		}
		cout<<"\nEnter new command: ";
		cin.getline(input,200,'\n');
		run_exec=1;
		
		
		cout<<"Run exec = "<<run_exec<<endl;

		
		cout<<"Test26"<<endl;
		goto begin;
	}

	else
	{
		cout<<"Test1"<<endl;
		
		
		cout<<"Run exec = "<<run_exec<<endl;
		if(run_exec == 1)
		{
			output = exec(input);
			cout<<endl<<output<<endl;
			cout<<"Test2"<<endl;
		}
		else if(run_exec == 0)
		{
			cout<<"Test3"<<endl;
			strcpy(new_dir,get_current_dir_name());
			cout<<"New dir = "<<new_dir<<endl;
			strcpy(token,strtok(NULL," "));
		
			cout<<"Test4"<<endl;
			if(strcmp(token,"..")==0)
			{
				cout<<"Test5"<<endl;
				int len=strlen(new_dir);
				while(new_dir[len-1]!='/')
				{
					len--;
				}
				new_dir[len-1]='\0';
				cout<<"New dir = "<<new_dir<<endl;
				cout<<"Test6"<<endl;
				cout<<"Test7"<<endl;
			}		
			else
			{
				cout<<"Test8"<<endl;
				strncpy(check,token,6);

				if( (strcmp(check,"/home")==0) || (strcmp(check,"/home/")==0) )
				{
					strcpy(new_dir, token);
					cout<<"Test9"<<endl;
				}
				else
				{
					strcat(new_dir,"/");
					strcat(new_dir,token);
					cout<<"Test10"<<endl;
					cout<<"Test11"<<endl;
				}
			}
			cout<<"Test12"<<endl;
			cout<<get_current_dir_name()<<endl;
			
			//Pipe from child to parent
			close (hpipe[READ]);
			char y = '\0';
			
			for(int i=0; new_dir[i]!='\0';i++)
				write(hpipe[WRITE], (char*)&new_dir[i], sizeof(char));
			write(hpipe[WRITE], (char*)&y, sizeof(char));
			close (hpipe[WRITE]);
			
			cout<<"Test13"<<endl;
		}
			
	}	
	
	last:
	if(finalflag==1)
		cout<<"End of shell. \n";
	exit(0);
	return 0;
}
